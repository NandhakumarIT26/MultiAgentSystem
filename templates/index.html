<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    body {
  font-family: 'Segoe UI', sans-serif;
}

.card {
  border-radius: 12px;
}

pre {
  background: #f8f9fa;
  padding: 10px;
  border-radius: 8px;
}

  </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Residue Utilization Planner</title>

  <!-- Bootstrap for styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="bg-light">
  <div class="container py-5">
    <h2 class="text-center mb-4 text-primary fw-bold">üåæ Residue Utilization Planning System</h2>

    <!-- Input Form -->
    <div class="card shadow p-4 mb-4">
      <h5 class="mb-3">Enter Crop & Soil Details</h5>
      <form id="plannerForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="crop" class="form-label">Crop Type</label>
            <input type="text" class="form-control" id="crop" placeholder="e.g. Rice" required>
          </div>
          <div class="col-md-6 mb-3">
            <label for="yield" class="form-label">Crop Yield (Tonnes)</label>
            <input type="number" class="form-control" id="yield" step="0.1" placeholder="e.g. 6.2" required>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="residue" class="form-label">Residue Amount (Tonnes)</label>
            <input type="number" class="form-control" id="residue" step="0.1" placeholder="e.g. 8.5" required>
          </div>
          <div class="col-md-6 mb-3">
            <label for="soil" class="form-label">Soil Type</label>
            <select class="form-select" id="soil" required>
              <option value="">Select Soil Type</option>
              <option value="">Select Soil Type</option>
  <option value="Loam">Alluvial Soil</option>
  <option value="Clay">Black (Regur) Soil</option>
  <option value="Loam">Red Soil</option>
  <option value="Loam">Laterite Soil</option>
  <option value="Sandy">Arid (Desert) Soil</option>
  <option value="Loam">Saline and Alkaline Soil</option>
  <option value="Clay">Peaty and Marshy Soil</option>
  <option value="Loam">Forest and Mountain Soil</option>
  <option value="Loam">Loamy Soil</option>
  <option value="Sandy">Sandy Soil</option>
  <option value="Clay">Clayey Soil</option>
  <option value="Loam">Coastal Alluvial Soil</option>
  <option value="Sandy">Lateritic Gravel Soil</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label for="location" class="form-label">Location</label>
          <input type="text" class="form-control" id="location" placeholder="e.g. Thanjavur, Tamil Nadu" required>
        </div>

        <div class="text-center">
          <button type="submit" class="btn btn-success px-5">Generate Plan</button>
        </div>
      </form>
    </div>

    <!-- Output Display -->
    <div id="outputSection" class="card shadow p-4" style="display:none;">
      <h5 class="mb-3 text-primary">üìä Generated Utilization Plan</h5>
      <div id="results" class="mb-4"></div>
      <div class="text-center">
        <canvas id="planChart" style="max-width: 400px; max-height: 250px;"></canvas>
      </div>
    </div>
  </div>

  <!-- JS Logic -->
  <script>
    const form = document.getElementById("plannerForm");
    const outputSection = document.getElementById("outputSection");
    const resultDiv = document.getElementById("results");
    let planChartInstance = null; // Store chart instance

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        crop: document.getElementById("crop").value,
        yield_t_per_ha: parseFloat(document.getElementById("yield").value),
        residue_tonnes: parseFloat(document.getElementById("residue").value),
        soil: document.getElementById("soil").value,
        location: document.getElementById("location").value
      };

      resultDiv.innerHTML = "<p class='text-center text-secondary'>‚è≥ Generating plan, please wait...</p>";

      try {
        const response = await fetch("/plan", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (!response.ok) throw new Error("Server error");

        const res = await response.json();
        outputSection.style.display = "block";

        const inputObj = res.Input || {};
        const initial = res.Initial_Plan || {};
        const fullFinal = res.Final_Output || {};
        const final = fullFinal?.Final_Optimized_Plan || {};
        const reasoning = fullFinal?.Optimizer_Reasoning || "No reasoning available";
        const sustainability = fullFinal?.Sustainability_Impact || {};
        const economic = fullFinal?.Economic_Impact || {};
        const confidence = fullFinal?.Confidence_Score || 0;
        const initialPlan = initial?.plan || {};
        const initialReasoning = initial?.reasoning || "No reasoning provided";

        // Format input data
        const formatInput = () => {
          return `
            <div class="mb-3">
              <strong>Crop Type:</strong> ${inputObj.crop || 'N/A'}<br>
              <strong>Yield per Hectare:</strong> ${inputObj.yield_t_per_ha || 'N/A'} tonnes<br>
              <strong>Residue Amount:</strong> ${inputObj.residue_tonnes || 'N/A'} tonnes<br>
              <strong>Soil Type:</strong> ${inputObj.soil || 'N/A'}<br>
              <strong>Location:</strong> ${inputObj.location || 'N/A'}
            </div>
          `;
        };

        // Format allocation plan
        const formatAllocation = (plan, title) => {
          if (!plan || Object.keys(plan).length === 0) {
            return `<p class="text-muted">No allocation data available</p>`;
          }
          let html = `<div class="table-responsive mb-3"><table class="table table-bordered table-sm">`;
          html += `<thead class="table-light"><tr><th>Method</th><th>Allocation (%)</th></tr></thead><tbody>`;
          for (const [method, percentage] of Object.entries(plan)) {
            html += `<tr><td>${method.replace(/_/g, ' ')}</td><td><strong>${percentage}%</strong></td></tr>`;
          }
          html += `</tbody></table></div>`;
          return html;
        };

        // Format metrics
        const formatMetrics = () => {
          let html = `<div class="row">`;
          
          if (sustainability && Object.keys(sustainability).length > 0) {
            html += `<div class="col-md-6 mb-3"><div class="card border-success"><div class="card-header bg-success text-white"><strong>Sustainability Impact</strong></div><div class="card-body">`;
            for (const [key, value] of Object.entries(sustainability)) {
              let label = key.replace(/_/g, ' ');
              let displayValue = value;
              if (key.includes('%') || key.includes('Percent') || key.includes('Reduction')) {
                displayValue = `${value}%`;
              } else if (key.includes('Score') && typeof value === 'number') {
                displayValue = value.toFixed(1);
              }
              html += `<p class="mb-2"><strong>${label}:</strong> <span class="text-success">${displayValue}</span></p>`;
            }
            html += `</div></div></div>`;
          }

          if (economic && Object.keys(economic).length > 0) {
            html += `<div class="col-md-6 mb-3"><div class="card border-primary"><div class="card-header bg-primary text-white"><strong>Economic Impact</strong></div><div class="card-body">`;
            for (const [key, value] of Object.entries(economic)) {
              const label = key.replace(/_/g, ' ').replace(/EST/g, '');
              let displayValue = value;
              if (key.includes('Revenue') && typeof value === 'number') {
                displayValue = `‚Çπ${value.toLocaleString('en-IN')}`;
              } else if (typeof value === 'number') {
                displayValue = value.toString();
              }
              html += `<p class="mb-2"><strong>${label}:</strong> <span class="text-primary">${displayValue}</span></p>`;
            }
            html += `</div></div></div>`;
          }
          
          html += `</div>`;
          return html;
        };

        resultDiv.innerHTML = `
          <div class="card mb-3">
            <div class="card-header bg-light"><strong>üìã Input Information</strong></div>
            <div class="card-body">${formatInput()}</div>
          </div>

          <div class="card mb-3">
            <div class="card-header bg-info text-white"><strong>üå± Initial Plan</strong></div>
            <div class="card-body">
              ${formatAllocation(initialPlan, 'Initial Plan')}
              <div class="mt-2">
                <strong>Reasoning:</strong> <em>${initialReasoning}</em><br>
                <strong>Confidence:</strong> ${initial?.confidence ? (initial.confidence * 100).toFixed(1) + '%' : 'N/A'}
              </div>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-header bg-success text-white"><strong>‚ú® Optimized Plan</strong></div>
            <div class="card-body">
              ${formatAllocation(final, 'Optimized Plan')}
              ${formatMetrics()}
              <div class="mt-3">
                <strong>Optimizer Reasoning:</strong><br>
                <p class="text-muted">${reasoning}</p>
                <strong>Confidence Score:</strong> <span class="badge bg-success">${(confidence * 100).toFixed(1)}%</span>
              </div>
            </div>
          </div>
        `;

        // Draw pie chart for allocation
        const ctx = document.getElementById('planChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (planChartInstance) {
          planChartInstance.destroy();
          planChartInstance = null;
        }
        
        // Format labels for better readability
        const labels = Object.keys(final).map(key => key.replace(/_/g, ' '));
        const values = Object.values(final);
        
        // Color scheme for allocation methods
        const colors = {
          'Compost': '#28a745',           // Green
          'Biochar': '#8b4513',            // Brown
          'Biogas': '#007bff',             // Blue
          'Feed or Storage': '#ffc107',    // Yellow
          'Feed_or_Storage': '#ffc107'      // Yellow (fallback)
        };
        
        // Map colors based on original keys
        const backgroundColors = Object.keys(final).map(key => {
          const cleanKey = key.replace(/_/g, ' ');
          return colors[key] || colors[cleanKey] || '#dc3545';
        });
        
        planChartInstance = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              label: 'Residue Allocation (%)',
              data: values,
              backgroundColor: backgroundColors,
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            aspectRatio: 1.5,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    return `${label}: ${value}%`;
                  }
                }
              }
            }
          }
        });

      } catch (err) {
        resultDiv.innerHTML = `<p class="text-danger text-center">‚ùå ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
